# Codex Audit: anza-xyz/mcp implementation worktree
- Local repo root: /home/anatoly/mcp
- Current branch: master
- Upstream: https://github.com/anza-xyz/mcp
- Upstream default branch: master (via `git remote show upstream`)
- Audit mode: assume adversarial/lazy author
<!-- CODEX_LAST_AUDITED: c5f4a1fabc59fffab7641c96b4293e70b7ba8a6c -->
- Last updated: 2026-01-22T19:59:12Z

## Latest Summary (most recent iteration)
- New commits audited this iteration: 1
- Highest risk finding: `mcp_spec.md` now includes wire layout and sizing that still diverge from code (witness_len size, payload format, tx_len width), so spec-as-truth marks large parts of the implementation as incorrect.
- Test status: `cargo fmt --check` failed due to nightly-only rustfmt options and formatting diffs; clippy/test not run.
- Issue coverage snapshot: 19 open issues fetched (unauthenticated GitHub API, first page only; no pagination). New commit updates spec only.

## Issue Map (Open upstream issues)
- #19: MCP-04 Transaction: update transaction format [Proposer] — status: OPEN — last updated: 2026-01-21T15:45:39Z
  - Evidence of work in this repo: e08adc174b
  - Notes: Adds config struct only; no integration with transaction/message parsing or fee calculation.
- #18: MCP-16 Replay: reconstruct messages from shreds [Replay] — status: OPEN — last updated: 2026-01-21T15:46:33Z
  - Evidence of work in this repo: a9f217887f
  - Notes: Reconstruction is a skeleton; no erasure coding or commitment verification implemented.
- #17: MCP-15 Replay: handle empty slots [Replay] — status: OPEN — last updated: 2026-01-21T15:46:32Z
  - Evidence of work in this repo: a9f217887f
  - Notes: Defines types/serialization only; no replay-stage integration.
- #16: MCP-14 Voting: validate and vote on blocks [-] — status: OPEN — last updated: 2026-01-21T15:46:30Z
  - Evidence of work in this repo: 19c13464f1, ca7621467a
  - Notes: Voting now accepts block_id from payload, but consensus payload ingestion is still not wired into turbine/replay.
- #15: MCP-13 Consensus Leader: broadcast block via turbine [Consensus] — status: OPEN — last updated: 2026-01-21T15:46:28Z
  - Evidence of work in this repo: 19c13464f1
  - Notes: Broadcast format defined but not wired into turbine.
- #14: MCP-12 Consensus Leader: aggregate relay attestations [Consensus] — status: OPEN — last updated: 2026-01-21T15:46:27Z
  - Evidence of work in this repo: a7414945f4
  - Notes: Aggregator does not verify signatures; assumes caller does.
- #13: MCP-11 Relay: submit attestations to leader [Relay] — status: OPEN — last updated: 2026-01-21T15:46:26Z
  - Evidence of work in this repo: a7414945f4
  - Notes: Wire format duplicates ledger module, risk of drift.
- #12: MCP-09 Relay: process and verify shreds [Relay] — status: OPEN — last updated: 2026-01-21T15:45:44Z
  - Evidence of work in this repo: 49f680818b, ca7621467a
  - Notes: Relay assignment check added, but witness length enforcement and silent-drop policy are still missing per spec.
- #11: MCP-07 Proposer: distribute shreds to relays [Proposer] — status: OPEN — last updated: 2026-01-21T15:45:42Z
  - Evidence of work in this repo: ac77f71f73, ca7621467a
  - Notes: Signature now binds shred_index, but witness length and batch size constraints are not enforced.
- #10: MCP-19 Proposer: Bankless Leader/proposer [Proposer] — status: OPEN — last updated: 2026-01-21T15:46:36Z
  - Evidence of work in this repo: 19c13464f1, ca7621467a
  - Notes: Bounds checks added, but constants differ from spec and ordering is still unspecified/unenforced.
- #9: MCP-10 Relay: record attestation [Relay] — status: OPEN — last updated: 2026-01-21T15:46:14Z
  - Evidence of work in this repo: 5c682d6104
  - Notes: Storage format exists but not wired to blockstore columns.
- #8: MCP-17 Replay: do an initial pass to deduct fees before applying state transitions [Replay] — status: OPEN — last updated: 2026-01-21T15:46:34Z
  - Evidence of work in this repo: 7b74e1891d
  - Notes: Fee phase implemented in isolation; not integrated with execution pipeline.
- #7: MCP-05 Proposer: add proposerID to the shred format [Proposer] — status: OPEN — last updated: 2026-01-21T15:45:40Z
  - Evidence of work in this repo: 3b37551c44
  - Notes: Critical offset mismatches in parsing; legacy shreds likely broken.
- #6: MCP-08 Proposer: update fee payer check to Address/test DA fee payer attacks [Proposer] — status: OPEN — last updated: 2026-01-21T15:45:43Z
  - Evidence of work in this repo: c081d11574, ca7621467a
  - Notes: Comments mention NUM_PROPOSERS, but enforcement remains spendable-balance only; still not integrated.
- #5: MCP-02 Setup: Proposer, Relay and Leader schedule [Setup] — status: OPEN — last updated: 2026-01-21T15:45:36Z
  - Evidence of work in this repo: bdcf8c135d, ca7621467a
  - Notes: Modular indexing removes duplicates, but pool size uses full validator set instead of role count per spec.
- #4: MCP-01 Setup: protocol constants [Setup] — status: OPEN — last updated: 2026-01-21T15:45:35Z
  - Evidence of work in this repo: 938bdaa693
  - Notes: Constants not wired into other modules; many duplicates in other crates.
- #3: MCP-06 Proposer: encode and commit [Proposer] — status: OPEN — last updated: 2026-01-21T15:45:41Z
  - Evidence of work in this repo: af5949c9e4
  - Notes: Constants only; shredder/merkle logic not updated to use MCP FEC.
- #2: MCP-03 Setup: Adjust blockstore to handle multiple proposers and execution consensus seperation. [Setup,Replay] — status: OPEN — last updated: 2026-01-21T15:45:38Z
  - Evidence of work in this repo: 39005c6fe5
  - Notes: CFs added but blockstore read/write paths not updated.
- #1: MCP-18 Replay: output ordered transactions [Replay] — status: OPEN — last updated: 2026-01-21T15:46:35Z
  - Evidence of work in this repo: a9f217887f
  - Notes: Ordering logic exists but not wired into replay stage.

## Commit-by-commit audit (chronological)
### 938bdaa693 — MCP-01: Add McpConfig with protocol constants
- Claimed intent: Centralize MCP protocol constants and config.
- Suspected upstream issue(s): #4
- Files changed: `ledger/src/mcp.rs`
- What actually changed (brief, concrete): New constants + `McpConfig` container; no usage elsewhere.
- Red flags / potential defects:
  - Constants duplicated later in other crates (core/turbine/svm) instead of using `McpConfig`, causing drift risk.
- Security considerations: None directly; misconfiguration risk if constants diverge.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Thread `McpConfig` through consensus/relay/replay paths and remove duplicate constants.

### bdcf8c135d — MCP-02: Implement proposer and relay schedules
- Claimed intent: Stake-weighted schedule with rotation for proposers/relays.
- Suspected upstream issue(s): #5
- Files changed: `ledger/src/mcp_schedule.rs`, `ledger/src/mcp_schedule_cache.rs`
- What actually changed: Adds schedule generation and caching using `WeightedIndex` sampling.
- Red flags / potential defects:
  - Sampling with replacement allows duplicate validators within a slot (`ledger/src/mcp_schedule.rs:322`), violating “unique proposer_id” assumptions and returning arbitrary first match (`ledger/src/mcp_schedule.rs:89`).
  - Test `test_proposer_relay_schedules_differ` is a no-op (compares lengths 16 vs 200) (`ledger/src/mcp_schedule.rs:392`).
- Security considerations: Duplicate scheduling could be abused to concentrate proposer slots.
- Test impact: Weak/ineffective tests; does not validate uniqueness.
- Verdict (Risk/Confidence/Status): HIGH / MED / Incorrect
- Recommended follow-ups: Use sampling without replacement and add explicit uniqueness tests for each slot.

### 39005c6fe5 — MCP-03: Add blockstore columns for multiple proposers
- Claimed intent: New CFs to support multi-proposer shreds and consensus/execution separation.
- Suspected upstream issue(s): #2
- Files changed: `ledger/src/blockstore/column.rs`, `ledger/src/blockstore_db.rs`, `ledger/src/lib.rs`
- What actually changed: Adds column families and key serialization only.
- Red flags / potential defects:
  - No read/write integration in blockstore paths; schema is unused and acceptance criteria are unmet.
- Security considerations: New CFs can bloat DB without serving functionality.
- Test impact: None.
- Verdict (Risk/Confidence/Status): MED / HIGH / Incomplete
- Recommended follow-ups: Wire new CFs into `blockstore.rs` and window service; add migration/compat notes.

### 3b37551c44 — MCP-05: Add proposer_id to shred common header
- Claimed intent: Add proposer_id to shred header and update offsets.
- Suspected upstream issue(s): #7
- Files changed: `ledger/src/shred.rs`, `ledger/src/shred/merkle.rs`, `ledger/src/shred/wire.rs`
- What actually changed: Header size increased by 1, new proposer_id field; some offsets updated.
- Red flags / potential defects:
  - Offsets still use legacy positions in merkle root calculations (`ledger/src/shred/merkle.rs:200`, `ledger/src/shred/merkle.rs:256`), breaking merkle verification/erasure indexing.
  - `get_reference_tick` reads byte 85 (legacy) while `get_flags` moved to 86 (`ledger/src/shred/wire.rs:203`).
  - `get_proposer_id` returns byte 79 for legacy shreds; that byte belongs to `fec_set_index`, not proposer_id (`ledger/src/shred/wire.rs:109`).
  - `get_common_header_bytes` always slices 84 bytes; legacy shreds used by dedup (`turbine/src/retransmit_stage.rs:212`) will be mis-keyed.
- Security considerations: Consensus-critical parsing inconsistencies can cause signature/merkle verification bypass or false failures.
- Test impact: No tests cover legacy/MCP compatibility or merkle offsets.
- Verdict (Risk/Confidence/Status): CRITICAL / HIGH / Incorrect
- Recommended follow-ups: Update all offsets consistently; add explicit legacy/MCP regression tests; ensure dedup uses correct header length.

### af5949c9e4 — MCP-06: Add MCP FEC rate constants (40 data + 160 coding)
- Claimed intent: Introduce MCP FEC constants and merkle proof size.
- Suspected upstream issue(s): #3
- Files changed: `ledger/src/shred.rs`, `ledger/src/shred/merkle_tree.rs`
- What actually changed: Adds constants only.
- Red flags / potential defects:
  - No integration with shredder/merkle encoding paths; constants are unused.
- Security considerations: None directly; but gives false sense of MCP FEC support.
- Test impact: None.
- Verdict (Risk/Confidence/Status): MED / HIGH / Incomplete
- Recommended follow-ups: Wire constants into shred creation/verification and update proof sizing logic.

### e08adc174b — MCP-04: Add MCP transaction config format with inclusion_fee and ordering_fee
- Claimed intent: Add transaction config and fee helpers.
- Suspected upstream issue(s): #19
- Files changed: `ledger/src/mcp.rs`
- What actually changed: Adds a `transaction` module with config mask serialization and fee helpers.
- Red flags / potential defects:
  - Not integrated into actual transaction/message parsing or `solana_fee::calculate_fee_details` as required by issue acceptance.
  - `target_proposer` is a `Pubkey` rather than a proposer ID (issue text suggests proposer targeting by ID).
- Security considerations: None, but parsing inconsistencies likely if clients implement differently.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / HIGH / Incomplete
- Recommended follow-ups: Implement wire integration in message/transaction crates and clarify `target_proposer` type.

### 5c682d6104 — MCP-10: Add relay attestation wire format and storage
- Claimed intent: Deterministic attestation wire format.
- Suspected upstream issue(s): #9
- Files changed: `ledger/src/lib.rs`, `ledger/src/mcp_attestation.rs`
- What actually changed: New attestation struct + serialization helpers.
- Red flags / potential defects:
  - Core uses a different attestation message format (`core/src/mcp_attestation_service.rs`), risking diverging encodings.
- Security considerations: Format drift can cause signature failures or acceptance mismatches across components.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Consolidate attestation format and reuse this module across core/turbine.

### c081d11574 — MCP-08: Add MCP fee payer validation to prevent DA attacks
- Claimed intent: Prevent fee payer overcommit in multi-proposer scenario.
- Suspected upstream issue(s): #6
- Files changed: `svm/src/mcp_fee_payer.rs`, `svm/src/lib.rs`
- What actually changed: Validator/tracker types, balance checks.
- Red flags / potential defects:
  - `SlotFeePayerTracker::can_commit` caps by spendable balance, not by `NUM_PROPOSERS * fee`, undermining the stated protection model.
  - Not integrated into transaction processing path.
- Security considerations: Under-enforcement enables DA griefing; over-enforcement can reject valid txs.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Align commitment logic with protocol requirement and wire into fee payer validation path.

### 49f680818b — MCP-09: Add relay shred processing and verification
- Claimed intent: Verify proposer shreds and track for attestation.
- Suspected upstream issue(s): #12
- Files changed: `turbine/src/mcp_relay.rs`, `turbine/src/lib.rs`
- What actually changed: New relay processing/verification structs.
- Red flags / potential defects:
  - Merkle proof verification uses `shred_index`, not relay index, while comments imply relay index verification (`turbine/src/mcp_relay.rs:263`). This fails to enforce relay assignment and enables arbitrary relays to claim any shred.
  - No constraints on witness size; could be used for memory/CPU DoS.
- Security considerations: Weak relay assignment checks enable spam and equivocation ambiguity.
- Test impact: Unit tests do not cover merkle proof correctness.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Define proof format explicitly, include relay index in validation, and bound witness size.

### ac77f71f73 — MCP-07: Add proposer shred distribution to relays
- Claimed intent: Proposers distribute shreds with commitments.
- Suspected upstream issue(s): #11
- Files changed: `turbine/src/mcp_proposer.rs`, `turbine/src/lib.rs`
- What actually changed: New distribution structs and serialization.
- Red flags / potential defects:
  - Signature covers only (slot, proposer_id, commitment); no binding to shred index or witness, enabling replay of stale commitments across shreds.
  - Relay selection is `idx % NUM_RELAYS`, with no scheduling tie-in.
- Security considerations: Ambiguous binding between shred and signature; potential replay/mix-up.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Include shred index in signed data and integrate with relay schedule.

### a7414945f4 — MCP-11/MCP-12: relay attestation submission and aggregation
- Claimed intent: Relay attestation submission and leader aggregation with equivocation detection.
- Suspected upstream issue(s): #13, #14
- Files changed: `core/src/mcp_attestation_service.rs`, `core/src/lib.rs`
- What actually changed: New wire format and aggregation logic.
- Red flags / potential defects:
  - `AttestationAggregator::add_attestation` does not verify relay signatures or relay_id validity; assumes caller did (`core/src/mcp_attestation_service.rs:170`).
  - Duplicate wire formats vs `ledger/src/mcp_attestation.rs`.
  - Attestation threshold uses stake of relays that submitted anything, not proposer-specific stake thresholds.
- Security considerations: Aggregator can be fed forged attestations if verification is skipped.
- Test impact: Unit tests only; no negative tests for signature failures.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Enforce signature verification inside aggregator and unify attestation format.

### 7b74e1891d — MCP-17: fee-only replay pass before state transitions
- Claimed intent: Two-phase fee charging with unconditional inclusion fees.
- Suspected upstream issue(s): #8
- Files changed: `svm/src/mcp_fee_replay.rs`, `svm/src/lib.rs`
- What actually changed: Fee phase structs; `execute_fee_phase` deducts all fees.
- Red flags / potential defects:
  - `conditional_fees` vs `unconditional_fees` is defined but unused; fee phase charges all fees regardless, which may contradict intended policy.
  - No integration into replay/execution pipeline.
- Security considerations: Charging policy ambiguity can cause consensus divergence.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Clarify fee policy and integrate with actual transaction processing.

### a9f217887f — MCP-15/16/18: replay components for empty slots, reconstruction, ordering
- Claimed intent: Replay stage structures for empty slots, reconstruction, ordering.
- Suspected upstream issue(s): #17, #18, #1
- Files changed: `core/src/mcp_replay.rs`, `core/src/lib.rs`
- What actually changed: Type definitions and local algorithms; no integration.
- Red flags / potential defects:
  - Reconstruction uses `total_shreds * 20%` without validating erasure coding or commitments.
  - Ordering assumes proposer IDs 0..15 and ignores proposer schedule or target proposer constraints.
- Security considerations: Placeholder logic can lead to mismatched ordering rules across nodes.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): MED / MED / Suspicious
- Recommended follow-ups: Implement real reconstruction and integrate with replay stage pipeline.

### 19c13464f1 — MCP-13/14/19: consensus broadcast, voting, bankless proposer
- Claimed intent: Consensus payload broadcast, block validation/voting, bankless leader.
- Suspected upstream issue(s): #15, #16, #10
- Files changed: `core/src/mcp_bankless.rs`, `core/src/mcp_consensus_broadcast.rs`, `core/src/mcp_voting.rs`, `core/src/lib.rs`
- What actually changed: New wire formats and validation structs.
- Red flags / potential defects:
  - `BlockValidator::compute_block_id` hashes slot + proposer roots, but `ConsensusPayload::block_id` hashes payload data; mismatch can cause vote disagreement (`core/src/mcp_voting.rs:236`).
  - `BanklessBatch::deserialize` trusts `tx_len` and allocates without bounds; potential memory DoS for malformed input (`core/src/mcp_bankless.rs:86`).
  - Signature verification is not enforced in `BanklessRecorder`; `RecordingStatus::InvalidSignature` is never reachable.
  - Constants duplicated (NUM_PROPOSERS/RELAYS and CONSENSUS_PAYLOAD_PROPOSER_ID) across core/ledger, no shared source.
- Security considerations: Divergent block_id computation and unbounded allocations can cause consensus or DoS issues.
- Test impact: Unit tests only.
- Verdict (Risk/Confidence/Status): HIGH / MED / Suspicious
- Recommended follow-ups: Unify block_id derivation, add size limits for deserialization, and wire signature checks.

### 2952d2ec84 — Add comprehensive MCP protocol specification
- Claimed intent: Consolidate all MCP issues into a single, unambiguous specification and declare implementation complete.
- Suspected upstream issue(s): References all MCP-01..MCP-19 items implicitly.
- Files changed: `mcp_spec.md`
- What actually changed (brief, concrete): Adds a 624-line specification document describing constants, wire formats, schedules, and role flows.
- Red flags / potential defects:
  - The spec asserts “Implementation Complete” while multiple subsystems are placeholders or unintegrated (see earlier commit audits); this is misleading and risks being used as authoritative guidance (`mcp_spec.md:4`).
  - Schedule generation described as a deterministic stake-weighted shuffle without replacement, but implementation uses `WeightedIndex` sampling with replacement in `ledger/src/mcp_schedule.rs:322`, enabling duplicate validators per slot (`mcp_spec.md:105`).
  - Transaction config layout is shown with fixed offsets (1-8, 9-16, 17-48), but the actual serialization is mask-ordered and variable-length in `ledger/src/mcp.rs`, so offsets depend on which bits are set; spec is ambiguous and incorrect (`mcp_spec.md:247`).
  - Proposer ordering rule uses “arrival time” as a tie-breaker, which is non-deterministic across validators and conflicts with the determinism requirement in Appendix B (`mcp_spec.md:283`, `mcp_spec.md:616`).
  - Block ID derivation references “canonical_aggregate_bytes” but never defines the canonical serialization of `SlotAggregate` or `ConsensusMeta`; the spec is incomplete and not executable (`mcp_spec.md:361`, `mcp_spec.md:514`).
  - Shred distribution to relays is underspecified (no mapping from shred index to relay_id, no rule for which relay receives which shred), making protocol behavior ambiguous (`mcp_spec.md:298`).
  - Fee payer requirements state `NUM_PROPOSERS * total_fee` for all account types but current code does not enforce this; the spec overstates implemented security guarantees (`mcp_spec.md:456`).
- Security considerations: A misleading spec can normalize unsafe or divergent behavior, making consensus bugs harder to detect during review and testing.
- Test impact: Documentation-only change; no tests updated.
- Verdict (Risk/Confidence/Status): MED / HIGH / Suspicious
- Recommended follow-ups: Mark the spec as draft or explicitly align it with current code; reconcile differences (schedules, fee rules, transaction config layout, block_id derivation) and link to tracking issues.

### 939aeba6de — Fix MCP specification accuracy and clarity
- Claimed intent: Correct MCP specification inaccuracies and clarify deterministic rules.
- Suspected upstream issue(s): References all MCP-01..MCP-19 items implicitly.
- Files changed: `mcp_spec.md`
- What actually changed (brief, concrete): Marks spec as draft, clarifies variable-length transaction config, defines canonical block_id serialization, adds relay assignment rule, replaces arrival-time tie-breaker with tx hash, adds unique selection note for schedules.
- Red flags / potential defects:
  - Schedule section now mandates “without replacement” selection and `role_magic` in the seed, but implementation uses `WeightedIndex` sampling with replacement and no role-specific seed (`ledger/src/mcp_schedule.rs:322`), so spec still conflicts with code.
  - Block_id derivation now matches consensus payload serialization, but `core/src/mcp_voting.rs` still computes block_id from a different input; spec/code divergence remains.
  - Relay assignment rule (`shred_index % NUM_RELAYS`) matches current proposer helper, but the spec still omits how this maps to the stake-weighted relay schedule (the rule ignores schedule ordering).
  - “Order by transaction hash” is a new deterministic rule but no code enforces ordering in bankless batch assembly; spec risks becoming aspirational rather than authoritative.
  - “Witness max 8 entries” is stated in the message format, but no limit is enforced in relay parsing, so the spec is not backed by code.
- Security considerations: Spec/code mismatches can lead to inconsistent third-party implementations and hidden consensus failures.
- Test impact: Documentation-only change; no tests updated.
- Verdict (Risk/Confidence/Status): MED / HIGH / Suspicious
- Recommended follow-ups: Align schedule selection and block_id computation across code and spec; document or remove relay assignment if not enforced by schedule; add explicit serialization limits for witnesses or remove the constraint.

### ca7621467a — Fix MCP spec underspecifications and implementation issues
- Claimed intent: Update MCP spec to remove underspecification and align implementations.
- Suspected upstream issue(s): References all MCP-01..MCP-19 items implicitly.
- Files changed: `mcp_spec.md`, `turbine/src/mcp_proposer.rs`, `turbine/src/mcp_relay.rs`, `ledger/src/mcp_schedule.rs`, `ledger/src/mcp_attestation.rs`, `core/src/mcp_voting.rs`, `core/src/mcp_bankless.rs`, `svm/src/mcp_fee_payer.rs`, plus minor constant re-exports and test adjustments.
- What actually changed (brief, concrete):
  - Spec adds batch limits, explicit SHA256 ordering, shred_index signature binding, relay assignment, witness size enforcement, modular indexing schedule details.
  - Proposer/relay messages now include shred_index in signature binding and serialization; relay checks `shred_index % NUM_RELAYS` and uses payload block_id in voting.
  - Schedule generation replaces weighted sampling with replacement by a weighted shuffle without replacement + modular indexing.
  - Bankless batch deserialization adds size/length limits (but with different constants than spec).
- Red flags / potential defects:
  - Spec mandates pool size equals role count (16/200), but code builds the pool from all validators (`ledger/src/mcp_schedule.rs:56-89`), so schedule selection deviates from spec.
  - Spec batch limits are 65,536 tx and 10 MB, but code enforces 10,000 tx and 16 MB; MAX_SHRED_DATA_SIZE (1,228) is not enforced anywhere (`mcp_spec.md:87`, `core/src/mcp_bankless.rs:114`).
  - Spec requires witness_len <= 8 and silent drop on violation; relay code does not enforce witness length or silent drop policy (`mcp_spec.md:326`, `turbine/src/mcp_relay.rs:224`).
  - Transaction ordering by SHA256(serialized_transaction) is specified, but no code performs ordering before serialization or replay (`mcp_spec.md:287`, `core/src/mcp_bankless.rs:96`).
  - Fee payer requirement remains unenforced (`mcp_spec.md:482`, `svm/src/mcp_fee_payer.rs:127`).
  - Commit adds `codex.md` and `codex_audit.sh` into the repo history; these are audit artifacts and unrelated to MCP, potentially accidental or inappropriate for upstream.
- Security considerations: Mismatched limits (batch size, witness) create DoS or consensus risk; schedule mismatch can alter stake-weighted selection; spec-driven implementations will diverge from this code.
- Test impact: New schedule uniqueness tests; no tests for witness limits or tx ordering.
- Verdict (Risk/Confidence/Status): HIGH / HIGH / Suspicious
- Recommended follow-ups: Align schedule pool size to spec, enforce witness length and batch size constants as specified, implement deterministic ordering, and decide whether audit artifacts belong in repo history.

### c5f4a1fabc — Comprehensive MCP spec update from mcp_spec_next.md and codex.md
- Claimed intent: Merge mcp_spec_next.md content into mcp_spec.md and incorporate audit fixes.
- Suspected upstream issue(s): References all MCP-01..MCP-19 items implicitly.
- Files changed: `mcp_spec.md`
- What actually changed (brief, concrete): Adds cryptographic primitives, explicit wire sizing (1225-byte shreds), McpPayloadV1/McpVoteV1 structures, derived thresholds, equivocation rule, de-duplication, and expanded determinism requirements.
- Red flags / potential defects:
  - Wire format now specifies `witness_len` as 1 byte with fixed 1225-byte shreds, but implementation uses 2-byte `witness_len` and variable-length witnesses (`turbine/src/mcp_proposer.rs:109`, `turbine/src/mcp_relay.rs:126`), so code is out of spec.
  - `McpPayloadV1` uses `tx_len: u16` and `tx_count: u16`, while `core/src/mcp_bankless.rs` uses `u32` lengths; this is a breaking serialization mismatch.
  - Spec enforces `MAX_TX_SIZE=4096`, but code caps tx size at 1232 bytes; spec-as-truth makes current limits wrong.
  - Spec requires 256-leaf Merkle tree with zero-padding leaves and 20-byte truncations; current merkle code does not document or implement the 256-leaf padding rule.
  - Spec introduces `McpVoteV1` format and validator registry indices; no code path uses or produces this format.
  - MTU requirement is still underspecified: 1225-byte shreds are asserted without stating the assumed MTU and overhead; `mcp_spec.md` should specify the packet budget explicitly.
- Security considerations: Divergent wire formats guarantee network incompatibility and can create silent consensus splits if some validators follow spec while others follow code.
- Test impact: Documentation-only change; no tests updated.
- Verdict (Risk/Confidence/Status): HIGH / HIGH / Suspicious
- Recommended follow-ups: Pick a single wire layout (witness_len size, tx_len width, packet budget) and update code + tests to match; explicitly define MTU/overhead assumptions in spec.

## Cross-cutting concerns (delta vs upstream)
- Behavioral changes that span commits:
  - Widespread constant duplication (NUM_PROPOSERS/RELAYS, CONSENSUS_PAYLOAD_PROPOSER_ID) across crates; risks drift and inconsistent behavior.
  - Many commits define types/serialization without integrating into actual pipeline (blockstore, turbine, replay, fee processing).
  - `mcp_spec.md` is now labeled draft but still contains rules that conflict with code (schedules, voting block_id), so external implementations remain at risk.
- Agave integration gaps (where implementation should actually live):
  - Shred format and header offsets must be enforced in the canonical shred parser/serializer (`ledger/src/shred.rs`, `ledger/src/shred/wire.rs`, `ledger/src/shred/merkle.rs`), not only in MCP-specific helpers.
  - Shred ingest and dedup should be in the existing TVU pipeline (`core/src/window_service.rs`, `turbine/src/sigverify_shreds.rs`, `turbine/src/retransmit_stage.rs`), otherwise MCP shreds never enter blockstore or replay.
  - Blockstore schema changes must be wired into primary read/write paths (`ledger/src/blockstore.rs`, `ledger/src/blockstore/column.rs`, `ledger/src/blockstore_db.rs`) and window_service insertion.
  - Consensus payload broadcast and verification should integrate with turbine broadcast (`turbine/src/broadcast_stage/standard_broadcast_run.rs`) and validator vote flow (`core/src/replay_stage.rs`, `core/src/consensus.rs`, `core/src/cluster_slots_service.rs`).
  - Transaction config parsing and fee calculation should be in the SDK/runtime path (`sdk/src/transaction.rs`, `sdk/src/message/*`, `fee/src/*`, `runtime/src/bank.rs`), not isolated in `ledger/src/mcp.rs`.
  - Two-phase fee charging and ordered replay must be driven from the actual replay/execution pipeline (`core/src/replay_stage.rs`, `runtime/src/bank.rs`) rather than standalone helpers.
- MCP-specific files created by Claude: integration plan
  - `ledger/src/mcp.rs`: should not define parallel transaction config in ledger; move/duplicate into SDK/runtime parsing (`sdk/src/transaction.rs`, `sdk/src/message/*`, `runtime/src/bank.rs`) and hook into fee calculation (`fee/src/*`).
  - `ledger/src/mcp_schedule.rs`, `ledger/src/mcp_schedule_cache.rs`: these should integrate with existing leader schedule utilities and caches (`ledger/src/leader_schedule_utils.rs`, `ledger/src/leader_schedule_cache.rs`) rather than introducing a parallel schedule system; consumers should be in window_service and turbine cluster_nodes.
  - `ledger/src/mcp_attestation.rs` vs `core/src/mcp_attestation_service.rs`: wire formats must be unified; the attestation encoding should live in ledger or sdk and be consumed by core/turbine, not duplicated.
  - `turbine/src/mcp_proposer.rs` and `turbine/src/mcp_relay.rs`: should be plugged into existing turbine broadcast and sigverify shreds pipeline; proposer/relay logic belongs in broadcast_stage and sigverify_shreds, not standalone modules.
  - `core/src/mcp_consensus_broadcast.rs`: should be integrated into `turbine/src/broadcast_stage/standard_broadcast_run.rs` and `core/src/tpu.rs` rather than a separate payload broadcaster.
  - `core/src/mcp_voting.rs`: must hook into actual vote generation and tower checks (`core/src/replay_stage.rs`, `core/src/consensus.rs`); otherwise it is dead logic.
  - `core/src/mcp_replay.rs`: should become part of `core/src/replay_stage.rs` and `ledger/src/blockstore_processor.rs` to produce real execution output, not a parallel replay path.
  - `core/src/mcp_bankless.rs`: should integrate with transaction ingestion and bankless leader paths in the existing banking pipeline (`core/src/banking_stage.rs`, `runtime/src/bank.rs`) or be removed; a detached recorder is unused.
  - `svm/src/mcp_fee_payer.rs` and `svm/src/mcp_fee_replay.rs`: must be wired into SVM transaction processing (`svm/src/transaction_processor.rs`, `runtime/src/bank.rs`) or are effectively no-ops.
## Issue-by-issue integration map (where changes should actually live)
- #1 MCP-18 Replay: output ordered transactions
  - Integrate into `core/src/replay_stage.rs`, `ledger/src/blockstore_processor.rs`, and execution ordering in `runtime/src/bank.rs`.
- #2 MCP-03 Blockstore multi-proposer + consensus/execution separation
  - Wire into `ledger/src/blockstore.rs`, `ledger/src/blockstore_db.rs`, `core/src/window_service.rs`, and `core/src/replay_stage.rs` (consensus payload vs execution output columns).
- #3 MCP-06 Proposer: encode and commit (FEC 40/160)
  - Implement in `ledger/src/shred.rs`, `ledger/src/shred/merkle.rs`, `turbine/src/broadcast_stage/standard_broadcast_run.rs`, and `turbine/src/sigverify_shreds.rs`.
- #4 MCP-01 Protocol constants
  - Centralize in `ledger/src/mcp.rs` but enforce consumption in `core/src/*`, `turbine/src/*`, `svm/src/*`, `runtime/src/*` to remove duplicates.
- #5 MCP-02 Proposer/Relay/Leader schedules
  - Merge into `ledger/src/leader_schedule_utils.rs` and `ledger/src/leader_schedule_cache.rs`, with use in `core/src/window_service.rs` and `turbine/src/cluster_nodes.rs`.
- #6 MCP-08 Fee payer anti-DA
  - Enforce in `svm/src/transaction_processor.rs` and `runtime/src/bank.rs` (not just helper structs).
- #7 MCP-05 Shred format proposer_id
  - Update canonical shred parser/serializer `ledger/src/shred.rs`, `ledger/src/shred/wire.rs`, `ledger/src/shred/merkle.rs`.
- #8 MCP-17 Fee-only replay pass
  - Integrate into `core/src/replay_stage.rs` and `runtime/src/bank.rs` execution pipeline.
- #9 MCP-10 Relay: record attestation
  - Implement storage in `ledger/src/blockstore.rs` and ingestion in `core/src/window_service.rs`.
- #10 MCP-19 Bankless proposer/leader
  - Integrate with `core/src/banking_stage.rs`, `runtime/src/bank.rs`, and vote/consensus hooks in `core/src/replay_stage.rs`.
- #11 MCP-07 Proposer distribute shreds to relays
  - Implement in `turbine/src/broadcast_stage/standard_broadcast_run.rs` and relay intake in `turbine/src/sigverify_shreds.rs`.
- #12 MCP-09 Relay process/verify shreds
  - Hook into `turbine/src/sigverify_shreds.rs` and `core/src/window_service.rs` to enforce per-relay checks.
- #13 MCP-11 Relay submit attestations
  - Wire into `core/src/cluster_info_vote_listener.rs` or a dedicated gossip/TPU path; use shared attestation format in `ledger/src/mcp_attestation.rs`.
- #14 MCP-12 Consensus leader aggregate relay attestations
  - Integrate into `core/src/consensus.rs` or leader block construction in `core/src/replay_stage.rs`.
- #15 MCP-13 Consensus leader broadcast block via turbine
  - Implement in `turbine/src/broadcast_stage/standard_broadcast_run.rs` with payload serialization in `core/src/mcp_consensus_broadcast.rs`.
- #16 MCP-14 Voting validate/vote on blocks
  - Integrate into `core/src/replay_stage.rs` and `core/src/consensus.rs` vote flow.
- #17 MCP-15 Replay handle empty slots
  - Implement in `core/src/replay_stage.rs` and persist to execution output column in `ledger/src/blockstore.rs`.
- #18 MCP-16 Replay reconstruct from shreds
  - Implement in `core/src/replay_stage.rs` using canonical shred/merkle utilities in `ledger/src/shred/*`.
- #19 MCP-04 Transaction format update
  - Implement in `sdk/src/message/*`, `sdk/src/transaction.rs`, `fee/src/*`, and `runtime/src/bank.rs` fee calculation.
- Spec divergence risk:
  - `mcp_spec_next.md` declares itself the “source-of-truth” with stable wire formats, but its wire layout and constants conflict with `mcp_spec.md` and current code (e.g., 4-byte proposer_index and 1-byte witness_len vs 1-byte proposer_id and 2-byte witness_len). Until reconciled, `mcp_spec_next.md` should not be treated as “better” or authoritative (`mcp_spec_next.md:1`, `mcp_spec_next.md:106`, `mcp_spec_next.md:365`).
  - MTU constraint is not consistently specified: `mcp_spec_next.md` hardcodes 1225-byte shreds but does not state the assumed MTU or overhead model, while `mcp_spec.md` uses `MAX_SHRED_DATA_SIZE` 1,228 without packet sizing context. The source-of-truth spec must define the exact MTU budget and overhead (IP/UDP/QUIC, signatures, proof sizes) or the wire format cannot be validated (`mcp_spec.md:92`, `mcp_spec_next.md:91`).
- Spec-as-source-of-truth deviations (code is buggy where it diverges):
  - [FIXED] Schedule pool size now equals role count (16/200) in `ledger/src/mcp_schedule.rs`.
  - [FIXED] Shred common header offsets now correctly read `fec_set_index` at bytes 80-83 in `ledger/src/shred/merkle.rs`.
  - [FIXED] Proposer ordering now sorts by ordering_fee DESC then tx hash ASC via `sort_for_serialization()` in `core/src/mcp_bankless.rs`.
  - [FIXED] Witness length capped at 8 entries (160 bytes) with `MAX_WITNESS_BYTES` check in `turbine/src/mcp_relay.rs`.
  - [FIXED] Batch limits aligned with spec (65,536 tx, 38,080 bytes, 4,096 max tx size) in `core/src/mcp_bankless.rs`.
  - [FIXED] Verification failures silently dropped via `Option<ValidatedShred>` return type in `turbine/src/mcp_relay.rs`.
  - [FIXED] Fee payer balance check now covers `NUM_PROPOSERS * total_fee` in `svm/src/mcp_fee_payer.rs:can_commit()`.
  - [OPEN] Replay reconstruction must use Reed-Solomon and verify commitments; `core/src/mcp_replay.rs` uses threshold logic without erasure recovery or merkle verification (`mcp_spec.md:437`, `core/src/mcp_replay.rs:88`).
  - [FIXED] Relay attestation aggregation now verifies relay signatures in `core/src/mcp_attestation_service.rs:add_attestation()`.
- API compatibility concerns:
  - Shred header size change not consistently handled; legacy shreds and merkle offsets are inconsistent.
- Dependency changes:
  - No new dependencies; new modules use existing crates.
- Performance/regression risks:
  - [FIXED] Bankless batch deserialization now has bounds checks (MAX_TRANSACTIONS_PER_BATCH, MAX_TRANSACTION_SIZE, MAX_BATCH_SIZE).
  - [FIXED] Witness vectors now limited to MAX_WITNESS_BYTES (160 bytes, 8 entries).
  - [FIXED] Schedule generation uses modular indexing to avoid duplicates per slot.

## Commands run + results (this iteration)
- `git rev-parse --show-toplevel`
  - Result: /home/anatoly/mcp
- `git status --porcelain=v1`
  - Result: `?? codex.md`
- `git branch --show-current`
  - Result: master
- `git remote -v`
  - Result: origin set; upstream added
- `git fetch upstream --prune`
  - Result: success
- `curl -sL "https://api.github.com/repos/anza-xyz/mcp/issues?state=open&per_page=100"`
  - Result: fetched 19 open issues (unauthenticated)
- `git rev-list --reverse 19c13464f132644cea6ce91043b69d589cf7e7f2..HEAD`
  - Result: 1 new commit (2952d2ec84)
- `git show --name-status --stat 2952d2ec84d311cff8f997c5116183fd261f7c18`
  - Result: adds `mcp_spec.md` (624 lines)
- `git show 2952d2ec84d311cff8f997c5116183fd261f7c18`
  - Result: documentation-only spec; no code changes
- `git diff --stat upstream/master..HEAD`
  - Result: 24 files changed, 6586 insertions, 11 deletions
- `git diff upstream/master..HEAD | rg -n "TODO|FIXME|HACK|unwrap\(|expect\(|panic!|unsafe|allow\(|deny\(|skip|ignored|only\s+in\s+test|password|token|secret"`
  - Result: no high-risk patterns beyond test unwraps and column key parsing
- `cargo fmt --check`
  - Result: failed; nightly rustfmt options unsupported and formatting diffs reported
- `git fetch --all --prune`
  - Result: success
- `rg -o --no-line-number "<!-- CODEX_LAST_AUDITED: ([0-9a-f]+) -->" -r '$1' codex.md | tail -n 1`
  - Result: ca7621467a1334fb702fe034b7ddb5495b27f87d
- `git rev-list --reverse ca7621467a1334fb702fe034b7ddb5495b27f87d..HEAD`
  - Result: no new commits
- `rg -n "replay_stage|window_service|broadcast_stage|turbine" core/src turbine/src ledger/src`
  - Result: located Agave integration points for MCP
- `git fetch --all --prune`
  - Result: success
- `rg -o --no-line-number "<!-- CODEX_LAST_AUDITED: ([0-9a-f]+) -->" -r '$1' codex.md | tail -n 1`
  - Result: ca7621467a1334fb702fe034b7ddb5495b27f87d
- `git rev-list --reverse ca7621467a1334fb702fe034b7ddb5495b27f87d..HEAD`
  - Result: 1 new commit (c5f4a1fabc)
- `git show --name-status --stat c5f4a1fabc59fffab7641c96b4293e70b7ba8a6c`
  - Result: spec-only update
- `git show c5f4a1fabc59fffab7641c96b4293e70b7ba8a6c`
  - Result: updates `mcp_spec.md` with new wire formats and primitives
- `git fetch --all --prune`
  - Result: success
- `rg -o --no-line-number "<!-- CODEX_LAST_AUDITED: ([0-9a-f]+) -->" -r '$1' codex.md | tail -n 1`
  - Result: 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd
- `git rev-list --reverse 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd..HEAD`
  - Result: no new commits
- `rg -n "" mcp_spec.md`
  - Result: re-scanned spec for correctness/completeness
- `git fetch --all --prune`
  - Result: success
- `rg -o --no-line-number "<!-- CODEX_LAST_AUDITED: ([0-9a-f]+) -->" -r '$1' codex.md | tail -n 1`
  - Result: 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd
- `git rev-list --reverse 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd..HEAD`
  - Result: 1 new commit (ca7621467a)
- `git show --name-status --stat ca7621467a1334fb702fe034b7ddb5495b27f87d`
  - Result: spec + multiple code changes
- `git show ca7621467a1334fb702fe034b7ddb5495b27f87d -- mcp_spec.md`
  - Result: spec updated with batch limits, signature binding, and verification rules
- `cargo fmt --check`
  - Result: failed; nightly rustfmt options unsupported and formatting diffs reported
- `rg -n "" mcp_spec.md`
  - Result: re-scanned spec for correctness/completeness
- `git fetch --all --prune`
  - Result: success
- `curl -sL "https://api.github.com/repos/anza-xyz/mcp/issues?state=open&per_page=100"`
  - Result: refreshed open issues (unauthenticated)
- `git rev-list --reverse 2952d2ec84d311cff8f997c5116183fd261f7c18..HEAD`
  - Result: 1 new commit (939aeba6de)
- `git show --name-status --stat 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd`
  - Result: `mcp_spec.md` updated
- `git show 939aeba6dedf1bf7427647b2e4bc83a17ffe9cfd`
  - Result: documentation-only update; no code changes
- `git diff --stat upstream/master..HEAD`
  - Result: 24 files changed, 6625 insertions, 11 deletions
- `git diff upstream/master..HEAD | rg -n "TODO|FIXME|HACK|unwrap\(|expect\(|panic!|unsafe|allow\(|deny\(|skip|ignored|only\s+in\s+test|password|token|secret"`
  - Result: no high-risk patterns beyond test unwraps and column key parsing
- `cargo fmt --check`
  - Result: failed; nightly rustfmt options unsupported and formatting diffs reported
